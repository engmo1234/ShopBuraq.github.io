<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BURΔQ | Cyber River Fashion</title>
    
    <!-- FAVICON & APP ICONS -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/FXAAShader.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { 
            font-family: 'Rajdhani', sans-serif;
            background: #000;
            color: white;
            position: relative;
        }
        
        /* CANVAS CONTAINER */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* PRELOADER */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s;
        }
        
        .preloader-content {
            text-align: center;
        }
        
        .preloader-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 2rem;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes logoGlow {
            from { filter: drop-shadow(0 0 10px rgba(0,240,255,0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(157,0,255,0.7)); }
        }
        
        .loading-bar {
            width: 300px;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .loading-progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00f0ff, #9d00ff);
            animation: loading 3s ease-in-out forwards;
        }
        
        @keyframes loading {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        /* NAVIGATION */
        .nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 2rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,240,255,0.2);
        }
        
        .nav-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            font-family: 'Orbitron', sans-serif;
            font-weight: 500;
            position: relative;
            padding: 0.5rem 0;
            transition: color 0.3s;
        }
        
        .nav-link:hover {
            color: #00f0ff;
        }
        
        .wallet-btn {
            padding: 0.8rem 2rem;
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            border: none;
            border-radius: 30px;
            color: black;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .wallet-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,240,255,0.3);
        }
        
        /* HERO SECTION */
        .hero {
            position: absolute;
            top: 50%;
            left: 5%;
            transform: translateY(-50%);
            max-width: 600px;
            z-index: 3;
        }
        
        .hero-badge {
            display: inline-block;
            padding: 1rem 2rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid #00f0ff;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 3px;
            margin-bottom: 3rem;
            backdrop-filter: blur(10px);
        }
        
        .hero-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(0,240,255,0.3);
        }
        
        .hero-subtitle {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 4rem;
            line-height: 1.6;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            color: black;
            box-shadow: 0 10px 30px rgba(0,240,255,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,240,255,0.5);
        }
        
        /* STATS OVERLAY */
        .stats-overlay {
            position: fixed;
            bottom: 5%;
            right: 5%;
            display: flex;
            gap: 2rem;
            z-index: 3;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 1.5rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0,240,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .stat-number {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.5rem;
        }
        
        /* CONTROL INFO */
        .controls-info {
            position: fixed;
            bottom: 5%;
            left: 5%;
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0,240,255,0.2);
            backdrop-filter: blur(10px);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
        }
        
        /* WEATHER CONTROL PANEL - MOVED TO LEFT TO PREVENT OVERLAP */
        .weather-control {
            position: fixed;
            top: 20%;
            left: 5%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.3);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0,240,255,0.2);
            backdrop-filter: blur(10px);
            z-index: 5;
        }
        
        .weather-slider {
            -webkit-appearance: none;
            width: 200px;
            height: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            outline: none;
        }
        
        .weather-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #00f0ff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .weather-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .weather-btn {
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(0,240,255,0.3);
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .weather-btn.active {
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            color: black;
        }
        
        /* BOAT CONTROL PANEL - STAYS ON RIGHT */
        .boat-control {
            position: fixed;
            top: 20%;
            right: 5%;
            background: rgba(0,0,0,0.3);
            padding: 1.5rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0,240,255,0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 5;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(0,240,255,0.3);
            border-radius: 5px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: rgba(0,240,255,0.2);
        }
        
        .control-btn:active {
            background: rgba(0,240,255,0.5);
            transform: scale(0.95);
        }
        
        .speed-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* DIRECTION INDICATOR */
        .direction-indicator {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0,240,255,0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .direction-arrow {
            font-size: 2rem;
            color: #00f0ff;
        }
        
        /* NFT SHOP WINDOW */
        .shop-window {
            position: fixed;
            top: 50%;
            right: -400px;
            transform: translateY(-50%);
            width: 350px;
            background: rgba(0,0,0,0.8);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid #00f0ff;
            backdrop-filter: blur(20px);
            z-index: 10;
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .shop-window.active {
            right: 5%;
        }
        
        .shop-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: linear-gradient(45deg, #00f0ff, #9d00ff);
            color: black;
            padding: 1rem;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            z-index: 9;
        }
        
        .nft-item {
            background: rgba(20,20,30,0.6);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0,240,255,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .nft-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,240,255,0.2);
        }
        
        .nft-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #00f0ff;
            margin: 1rem 0;
        }
        
        /* SNOWFLAKES OVERLAY */
        .snowflakes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            filter: blur(0.5px);
        }
        
        /* RESPONSIVE - Simple fix for mobile */
        @media (max-width: 1200px) {
            /* Move weather control lower on medium screens */
            .weather-control {
                top: 30%;
            }
        }
        
        @media (max-width: 1024px) {
            /* Stack boat control below weather control */
            .weather-control {
                top: 20%;
                left: 5%;
            }
            
            .boat-control {
                top: 35%;
                right: 5%;
            }
        }
        
        @media (max-width: 768px) {
            .hero-title { font-size: 3rem; }
            .hero { left: 2%; right: 2%; }
            .stats-overlay { 
                flex-direction: column; 
                bottom: 15%;
                right: 5%;
                left: 5%;
                align-items: center;
            }
            
            /* Hide weather and boat controls on mobile */
            .weather-control, .boat-control { 
                display: none; 
            }
            
            .controls-info { 
                font-size: 0.7rem; 
                padding: 0.5rem 1rem;
                bottom: 5%;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                text-align: center;
            }
            
            .direction-indicator { 
                top: 12%; 
                padding: 0.5rem 1rem; 
            }
            
            .nav-links {
                gap: 1rem;
            }
            
            .nav {
                padding: 1rem 5%;
            }
            
            .nav-logo {
                font-size: 1.5rem;
            }
            
            .wallet-btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .shop-window {
                width: 90%;
                right: -100%;
            }
            
            .shop-window.active {
                right: 5%;
            }
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 0; }
        
        /* ANIMATIONS */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body>
    <!-- CANVAS CONTAINER -->
    <div id="canvas-container"></div>
    
    <!-- SNOWFLAKES OVERLAY -->
    <div class="snowflakes" id="snowflakes"></div>
    
    <!-- PRELOADER -->
    <div class="preloader" id="preloader">
        <div class="preloader-content">
            <div class="preloader-logo">BURΔQ</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>
    
    <!-- NAVIGATION -->
    <nav class="nav">
        <a href="#" class="nav-logo">BURΔQ</a>
        <div class="nav-links">
            <a href="#shop" class="nav-link">SHOP</a>
            <a href="#" class="nav-link">COLLECTION</a>
            <a href="#" class="nav-link">ABOUT</a>
            <a href="#" class="nav-link">CONTACT</a>
        </div>
        <button class="wallet-btn" id="connectWallet">
            <i class="fas fa-wallet"></i> CONNECT WALLET
        </button>
    </nav>
    
    <!-- HERO -->
    <section class="hero">
        <div class="hero-badge floating">PHYGITAL FASHION DROP #001</div>
        <h1 class="hero-title">RIDE THE<br>DIGITAL RIVER</h1>
        <p class="hero-subtitle">
            Where cyberpunk fashion meets blockchain technology. 
            Each garment is a token, each token tells a story. 
            Navigate the digital currents with us.
        </p>
        <div class="button-grid">
            <button class="btn btn-primary" id="shopToggle">
                <i class="fas fa-store"></i> OPEN SHOP
            </button>
            <button class="btn btn-primary" id="speedUp">
                <i class="fas fa-tachometer-alt"></i> INCREASE SPEED
            </button>
        </div>
    </section>
    
    <!-- STATS -->
    <div class="stats-overlay">
        <div class="stat-item">
            <div class="stat-number" id="boatSpeed">75</div>
            <div class="stat-label">KM/H</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="weatherIntensity">2500</div>
            <div class="stat-label">PARTICLES</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="distance">0.0</div>
            <div class="stat-label">KM TRAVELED</div>
        </div>
    </div>
    
    <!-- DIRECTION INDICATOR -->
    <div class="direction-indicator">
        <div>BOAT POSITION</div>
        <div class="direction-arrow" id="directionArrow">↓</div>
        <div id="riverPosition">Z: 0.0</div>
    </div>
    
    <!-- CONTROLS INFO -->
    <div class="controls-info">
        <div>←→ ARROW KEYS: STEER BOAT</div>
        <div>↑↓ ARROW KEYS: MOVE UP/DOWN RIVER</div>
        <div>SPACEBAR: NITRO BOOST</div>
        <div>W/S: MOVE FORWARD/BACKWARD</div>
        <div>SCROLL: ZOOM IN/OUT</div>
    </div>
    
    <!-- WEATHER CONTROL - MOVED TO LEFT SIDE -->
    <div class="weather-control">
        <div>WEATHER INTENSITY</div>
        <input type="range" min="0" max="100" value="50" class="weather-slider" id="weatherSlider">
        <div>WEATHER TYPE: <span id="weatherType">SNOW</span></div>
        <div class="weather-buttons">
            <button class="weather-btn active" data-weather="snow">SNOW</button>
            <button class="weather-btn" data-weather="rain">RAIN</button>
            <button class="weather-btn" data-weather="fog">FOG</button>
        </div>
    </div>
    
    <!-- BOAT CONTROL PANEL - STAYS ON RIGHT -->
    <div class="boat-control">
        <div>BOAT CONTROL</div>
        <div class="control-buttons">
            <button class="control-btn" id="boatForward"><i class="fas fa-arrow-up"></i></button>
            <button class="control-btn" id="boatBoost"><i class="fas fa-bolt"></i></button>
            <button class="control-btn" id="boatBackward"><i class="fas fa-arrow-down"></i></button>
            <button class="control-btn" id="boatLeft"><i class="fas fa-arrow-left"></i></button>
            <button class="control-btn" id="boatCenter"><i class="fas fa-bullseye"></i></button>
            <button class="control-btn" id="boatRight"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div class="speed-value" id="currentSpeed">75</div>
        <div>KM/H CURRENT</div>
    </div>
    
    <!-- SHOP WINDOW -->
    <div class="shop-toggle" id="shopToggleBtn">
        <i class="fas fa-shopping-bag"></i> SHOP
    </div>
    <div class="shop-window" id="shopWindow">
        <h2 style="font-family:'Orbitron';margin-bottom:1.5rem;color:#00f0ff">NFT FASHION</h2>
        
        <div class="nft-item">
            <h3 style="font-family:'Orbitron'">CYBER JACKET</h3>
            <p>Limited edition with NFC chip</p>
            <div class="nft-price">0.15 ETH</div>
            <button class="btn btn-primary" style="width:100%" onclick="buyProduct('cyber-jacket')">
                BUY NOW
            </button>
        </div>
        
        <div class="nft-item">
            <h3 style="font-family:'Orbitron'">RIVER RUNNERS</h3>
            <p>Water-resistant smart shoes</p>
            <div class="nft-price">0.08 ETH</div>
            <button class="btn btn-primary" style="width:100%" onclick="buyProduct('river-runners')">
                BUY NOW
            </button>
        </div>
        
        <div class="nft-item">
            <h3 style="font-family:'Orbitron'">DIGITAL CAPE</h3>
            <p>AR-enabled wearable</p>
            <div class="nft-price">0.25 ETH</div>
            <button class="btn btn-primary" style="width:100%" onclick="buyProduct('digital-cape')">
                BUY NOW
            </button>
        </div>
    </div>

    <script>
        // PRELOADER
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('preloader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('preloader').style.display = 'none';
                    initScene();
                    createSnowflakes();
                }, 500);
            }, 3000);
        });

        // THREE.JS SCENE
        let scene, camera, renderer, composer;
        let boat, river, cityBuildings = [];
        let particles = [];
        let particleCount = 2500;
        let boatSpeed = 75;
        let distanceTraveled = 0;
        let riverWidth = 100;
        let riverLength = 500;
        let boatPositionX = 0;
        let boatPositionZ = 0; // NEW: Boat position along the river (Z-axis)
        let boatHeight = -3;
        let clock = new THREE.Clock();
        let riverMaterial, waterTexture;
        let particleGeometry, particleMaterial, particleSystem;
        let lightParticles = [];
        let fogParticles = [];
        let controls;
        let nitroActive = false;
        let speedBoost = 1;
        let weatherType = 'snow';
        let weatherIntensity = 0.5;
        let buildings = [];
        let riverDirection = 1; // 1 for downstream, -1 for upstream
        let boatVelocity = 0;

        function initScene() {
            // SCENE SETUP
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x001133, 50, 300);
            
            // CAMERA
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 30, 60);
            camera.lookAt(0, 0, 0);
            
            // RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // POST-PROCESSING
            composer = new THREE.EffectComposer(renderer);
            const renderPass = new THREE.RenderPass(scene, camera);
            composer.addPass(renderPass);
            
            const fxaaPass = new THREE.ShaderPass(THREE.FXAAShader);
            fxaaPass.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
            composer.addPass(fxaaPass);
            
            // CONTROLS
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 30;
            controls.maxDistance = 200;
            controls.maxPolarAngle = Math.PI / 2.5;
            
            // LIGHTING
            const ambientLight = new THREE.AmbientLight(0x334466, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0x88aaff, 0.9);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0x00ffff, 0.8, 200);
            pointLight.position.set(0, 20, 0);
            scene.add(pointLight);
            
            // HEMISPHERE LIGHT FOR SNOWY ENVIRONMENT
            const hemisphereLight = new THREE.HemisphereLight(0x4488ff, 0x002266, 0.5);
            scene.add(hemisphereLight);
            
            // CREATE RIVER WITH ICE EFFECT
            createRiver();
            
            // CREATE ENHANCED BOAT
            createBoat();
            
            // CREATE WEATHER PARTICLES
            createWeatherParticles();
            
            // CREATE POLISHED CITY BUILDINGS WITH SNOW
            createCity();
            
            // CREATE LIGHT PARTICLES
            createLightParticles();
            
            // CREATE FOG PARTICLES
            createFogParticles();
            
            // KEYBOARD CONTROLS
            setupControls();
            
            // UI CONTROLS
            setupUIControls();
            
            // START ANIMATION
            animate();
            
            // WINDOW RESIZE
            window.addEventListener('resize', onWindowResize);
        }

        function createRiver() {
            const riverGeometry = new THREE.PlaneGeometry(riverWidth, riverLength, 100, 200);
            
            // Create advanced water material with ice/snow effect
            waterTexture = new THREE.TextureLoader().load('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80');
            waterTexture.wrapS = waterTexture.wrapT = THREE.RepeatWrapping;
            waterTexture.repeat.set(10, 20);
            
            riverMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0 },
                    waterTexture: { value: waterTexture },
                    color1: { value: new THREE.Color(0x002288) },
                    color2: { value: new THREE.Color(0x0044cc) },
                    iceColor: { value: new THREE.Color(0xaaccff) },
                    speed: { value: 0.5 },
                    snowAmount: { value: 0.3 }
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vPosition;
                    uniform float time;
                    void main() {
                        vUv = uv;
                        vPosition = position;
                        vec3 pos = position;
                        // Wave animation
                        pos.x += sin(pos.y * 0.5 + time) * 0.5;
                        pos.z += cos(pos.x * 0.3 + time * 0.7) * 0.3;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform vec3 color1;
                    uniform vec3 color2;
                    uniform vec3 iceColor;
                    uniform float time;
                    uniform float speed;
                    uniform float snowAmount;
                    uniform sampler2D waterTexture;
                    varying vec2 vUv;
                    varying vec3 vPosition;
                    
                    void main() {
                        // Base water color with waves
                        float wave = sin(vUv.x * 10.0 + time * speed) * 0.5 + 0.5;
                        vec3 waterColor = mix(color1, color2, wave);
                        
                        // Ice/snow effect at edges
                        float edgeFactor = 1.0 - abs(vUv.x - 0.5) * 2.0;
                        float iceFactor = smoothstep(0.7, 1.0, edgeFactor) * snowAmount;
                        
                        // Snow on top of ice
                        float snowPattern = sin(vUv.x * 50.0 + time) * 0.5 + 0.5;
                        snowPattern *= sin(vUv.y * 30.0 + time * 0.5) * 0.5 + 0.5;
                        float snowFactor = iceFactor * snowPattern * 0.3;
                        
                        // Combine colors
                        vec3 finalColor = mix(waterColor, iceColor, iceFactor);
                        finalColor = mix(finalColor, vec3(1.0, 1.0, 1.0), snowFactor);
                        
                        // Texture blending
                        vec4 texColor = texture2D(waterTexture, vUv * 2.0 + time * 0.01);
                        finalColor = mix(finalColor, finalColor * texColor.rgb, 0.3);
                        
                        // Transparency
                        float alpha = 0.9 - abs(vUv.x - 0.5) * 0.5;
                        alpha = min(alpha, 1.0 - iceFactor * 0.3);
                        
                        gl_FragColor = vec4(finalColor, alpha);
                    }
                `,
                transparent: true,
                side: THREE.DoubleSide
            });
            
            river = new THREE.Mesh(riverGeometry, riverMaterial);
            river.rotation.x = -Math.PI / 2;
            river.position.y = -5;
            scene.add(river);
            
            // Create snowy river banks
            const bankGeometry = new THREE.BoxGeometry(riverWidth + 20, 6, riverLength);
            const bankMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x334455,
                roughness: 0.9,
                metalness: 0.1
            });
            
            const leftBank = new THREE.Mesh(bankGeometry, bankMaterial);
            leftBank.position.set(-(riverWidth/2 + 10), -8, 0);
            scene.add(leftBank);
            
            const rightBank = new THREE.Mesh(bankGeometry, bankMaterial);
            rightBank.position.set(riverWidth/2 + 10, -8, 0);
            scene.add(rightBank);
            
            // Add snow to banks
            for(let i = 0; i < 200; i++) {
                const snowGeometry = new THREE.SphereGeometry(Math.random() * 1.5 + 0.5, 6, 6);
                const snowMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.9
                });
                const snow = new THREE.Mesh(snowGeometry, snowMaterial);
                
                const side = Math.random() > 0.5 ? 1 : -1;
                const bankPos = (riverWidth/2 + 8) * side;
                snow.position.set(
                    bankPos + (Math.random() - 0.5) * 8 * side,
                    -5 + Math.random() * 3,
                    (Math.random() - 0.5) * riverLength
                );
                scene.add(snow);
            }
        }

        function createBoat() {
            const boatGroup = new THREE.Group();
            
            // Advanced hull with cyberpunk design
            const hullGeometry = new THREE.CylinderGeometry(2, 3, 12, 12, 1, false, 0, Math.PI);
            const hullMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x00ffff,
                emissive: 0x003333,
                emissiveIntensity: 0.5,
                metalness: 0.9,
                roughness: 0.1
            });
            const hull = new THREE.Mesh(hullGeometry, hullMaterial);
            hull.rotation.z = Math.PI / 2;
            hull.rotation.x = Math.PI / 2;
            boatGroup.add(hull);
            
            // Cockpit with glass effect
            const cockpitGeometry = new THREE.BoxGeometry(5, 3, 4);
            const cockpitMaterial = new THREE.MeshPhysicalMaterial({ 
                color: 0x111111,
                transparent: true,
                opacity: 0.3,
                transmission: 0.5,
                roughness: 0.1,
                metalness: 0.9,
                clearcoat: 1.0,
                clearcoatRoughness: 0.1
            });
            const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
            cockpit.position.set(0, 2, 0);
            boatGroup.add(cockpit);
            
            // Engine with glow effect
            const engineGeometry = new THREE.CylinderGeometry(1.2, 1.8, 5, 12);
            const engineMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xff3300,
                emissive: 0x331100,
                emissiveIntensity: 1.5,
                metalness: 0.9,
                roughness: 0.1
            });
            const engine = new THREE.Mesh(engineGeometry, engineMaterial);
            engine.position.set(0, 1, -5);
            boatGroup.add(engine);
            
            // Engine glow light
            const engineLight = new THREE.PointLight(0xff3300, 3, 30);
            engineLight.position.set(0, 1, -6);
            boatGroup.add(engineLight);
            
            // Navigation lights
            const leftLight = new THREE.PointLight(0x00ff00, 1.5, 15);
            leftLight.position.set(-2.5, 1.5, 5);
            boatGroup.add(leftLight);
            
            const rightLight = new THREE.PointLight(0xff0000, 1.5, 15);
            rightLight.position.set(2.5, 1.5, 5);
            boatGroup.add(rightLight);
            
            // Neon accents
            const neonGeometry = new THREE.TorusGeometry(1.5, 0.2, 8, 20);
            const neonMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x9d00ff,
                emissive: 0x9d00ff,
                emissiveIntensity: 2,
                metalness: 0.9,
                roughness: 0.1
            });
            const neonRing = new THREE.Mesh(neonGeometry, neonMaterial);
            neonRing.position.set(0, 0.5, 0);
            neonRing.rotation.x = Math.PI / 2;
            boatGroup.add(neonRing);
            
            boat = boatGroup;
            boat.position.set(0, boatHeight, 0);
            scene.add(boat);
        }

        function createWeatherParticles() {
            particleGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for(let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 200;
                positions[i * 3 + 1] = Math.random() * 100 + 50;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 500;
                
                // White color for snow
                colors[i * 3] = 1.0; // R
                colors[i * 3 + 1] = 1.0; // G
                colors[i * 3 + 2] = 1.0; // B
            }
            
            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            particleMaterial = new THREE.PointsMaterial({
                size: 0.8,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });
            
            particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particleSystem);
        }

        function createCity() {
            // Create detailed cyberpunk city with snow
            for(let i = 0; i < 80; i++) {
                const buildingGroup = new THREE.Group();
                
                // Random building parameters
                const buildingHeight = Math.random() * 40 + 20;
                const buildingWidth = Math.random() * 8 + 5;
                const buildingDepth = Math.random() * 8 + 5;
                const floors = Math.floor(buildingHeight / 4);
                
                // Main building structure
                const buildingGeometry = new THREE.BoxGeometry(buildingWidth, buildingHeight, buildingDepth);
                const buildingMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x112244,
                    emissive: 0x001133,
                    emissiveIntensity: 0.3,
                    metalness: 0.8,
                    roughness: 0.3
                });
                
                const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                building.castShadow = true;
                building.receiveShadow = true;
                buildingGroup.add(building);
                
                // Snow on roof
                const snowGeometry = new THREE.BoxGeometry(buildingWidth + 2, 1, buildingDepth + 2);
                const snowMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffffff,
                    roughness: 0.9,
                    metalness: 0.1
                });
                const snow = new THREE.Mesh(snowGeometry, snowMaterial);
                snow.position.y = buildingHeight/2 + 0.5;
                buildingGroup.add(snow);
                
                // Windows with neon lights
                for(let j = 0; j < floors; j++) {
                    for(let k = 0; k < 4; k++) {
                        const windowWidth = 1;
                        const windowHeight = 1.5;
                        const windowGeometry = new THREE.BoxGeometry(windowWidth, windowHeight, 0.2);
                        
                        // Random neon colors
                        const neonColors = [0x00ffff, 0xff00ff, 0xffff00, 0xff3300];
                        const neonColor = neonColors[Math.floor(Math.random() * neonColors.length)];
                        
                        const windowMaterial = new THREE.MeshStandardMaterial({ 
                            color: neonColor,
                            emissive: neonColor,
                            emissiveIntensity: 2,
                            metalness: 0.9,
                            roughness: 0.1
                        });
                        
                        const window = new THREE.Mesh(windowGeometry, windowMaterial);
                        
                        // Position windows on all sides
                        const side = k;
                        const windowY = -buildingHeight/2 + j * 4 + 2.5;
                        
                        switch(side) {
                            case 0: // Front
                                window.position.set(0, windowY, buildingDepth/2 + 0.1);
                                break;
                            case 1: // Back
                                window.position.set(0, windowY, -buildingDepth/2 - 0.1);
                                break;
                            case 2: // Right
                                window.position.set(buildingWidth/2 + 0.1, windowY, 0);
                                window.rotation.y = Math.PI / 2;
                                break;
                            case 3: // Left
                                window.position.set(-buildingWidth/2 - 0.1, windowY, 0);
                                window.rotation.y = Math.PI / 2;
                                break;
                        }
                        
                        buildingGroup.add(window);
                    }
                }
                
                // Place building
                const side = Math.random() > 0.5 ? 1 : -1;
                buildingGroup.position.set(
                    (riverWidth/2 + 40 + Math.random() * 60) * side,
                    buildingHeight/2 - 5,
                    (Math.random() - 0.5) * riverLength
                );
                
                // Add some rotation for variety
                buildingGroup.rotation.y = Math.random() * 0.1;
                
                scene.add(buildingGroup);
                buildings.push(buildingGroup);
            }
            
            // Add distant mountains with snow
            for(let i = 0; i < 12; i++) {
                const mountainHeight = Math.random() * 100 + 80;
                const mountainGeometry = new THREE.ConeGeometry(100, mountainHeight, 10);
                const mountainMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x223355,
                    roughness: 0.9,
                    metalness: 0.1
                });
                
                const mountain = new THREE.Mesh(mountainGeometry, mountainMaterial);
                mountain.position.set(
                    (Math.random() - 0.5) * 400,
                    -100,
                    -300 + i * 80
                );
                scene.add(mountain);
                
                // Snow on mountain peaks
                const snowPeakGeometry = new THREE.ConeGeometry(90, 20, 10);
                const snowPeakMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffffff,
                    roughness: 0.8
                });
                
                const snowPeak = new THREE.Mesh(snowPeakGeometry, snowPeakMaterial);
                snowPeak.position.set(
                    mountain.position.x,
                    mountain.position.y + mountainHeight/2 - 5,
                    mountain.position.z
                );
                scene.add(snowPeak);
            }
        }

        function createLightParticles() {
            const particleCount = 1500;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for(let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 200;
                positions[i * 3 + 1] = Math.random() * 50;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 500;
                
                // Blue/cyan colors for cyberpunk atmosphere
                colors[i * 3] = 0.2 + Math.random() * 0.3; // R
                colors[i * 3 + 1] = 0.5 + Math.random() * 0.5; // G
                colors[i * 3 + 2] = 1.0; // B
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.6,
                vertexColors: true,
                transparent: true,
                opacity: 0.4,
                blending: THREE.AdditiveBlending
            });
            
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
            lightParticles.push(particles);
        }

        function createFogParticles() {
            const fogGeometry = new THREE.BufferGeometry();
            const fogCount = 800;
            const positions = new Float32Array(fogCount * 3);
            
            for(let i = 0; i < fogCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 100;
                positions[i * 3 + 1] = Math.random() * 20 - 10;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 500;
            }
            
            fogGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const fogMaterial = new THREE.PointsMaterial({
                color: 0xaaccff,
                size: 8,
                transparent: true,
                opacity: 0.08,
                blending: THREE.AdditiveBlending
            });
            
            const fog = new THREE.Points(fogGeometry, fogMaterial);
            scene.add(fog);
            fogParticles.push(fog);
        }

        function setupControls() {
            const keys = {};
            
            document.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                
                if(e.code === 'Space') {
                    nitroActive = true;
                    speedBoost = 2.5;
                    setTimeout(() => {
                        nitroActive = false;
                        speedBoost = 1;
                    }, 2000);
                }
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
            
            // Update boat position based on keys
            function updateBoatPosition() {
                // Left/Right movement
                if(keys['ArrowLeft'] || keys['KeyA']) {
                    boatPositionX = Math.max(boatPositionX - 0.8, -riverWidth/2 + 5);
                }
                if(keys['ArrowRight'] || keys['KeyD']) {
                    boatPositionX = Math.min(boatPositionX + 0.8, riverWidth/2 - 5);
                }
                
                // Up/Down river movement (Forward/Backward along Z-axis)
                if(keys['ArrowUp'] || keys['KeyW']) {
                    // Move UP river (negative Z direction)
                    boatPositionZ -= boatSpeed * 0.02 * speedBoost;
                    boatVelocity = -boatSpeed * speedBoost;
                    riverDirection = -1; // Upstream
                }
                if(keys['ArrowDown'] || keys['KeyS']) {
                    // Move DOWN river (positive Z direction)
                    boatPositionZ += boatSpeed * 0.02 * speedBoost;
                    boatVelocity = boatSpeed * speedBoost;
                    riverDirection = 1; // Downstream
                }
                
                // Speed adjustment
                if(keys['Equal'] || keys['NumpadAdd']) {
                    boatSpeed = Math.min(boatSpeed + 2, 200);
                }
                if(keys['Minus'] || keys['NumpadSubtract']) {
                    boatSpeed = Math.max(boatSpeed - 2, 10);
                }
                
                // Update UI
                document.getElementById('boatSpeed').textContent = Math.floor(boatSpeed);
                document.getElementById('currentSpeed').textContent = Math.floor(boatSpeed * speedBoost);
                document.getElementById('riverPosition').textContent = `Z: ${boatPositionZ.toFixed(1)}`;
                
                // Update direction arrow
                const directionArrow = document.getElementById('directionArrow');
                if(riverDirection === -1) {
                    directionArrow.textContent = '↑';
                    directionArrow.style.color = '#00ff9d';
                } else {
                    directionArrow.textContent = '↓';
                    directionArrow.style.color = '#00f0ff';
                }
            }
            
            // Add update to animation loop
            const originalAnimate = animate;
            window.animate = function() {
                updateBoatPosition();
                originalAnimate();
            };
        }

        function setupUIControls() {
            // Boat control buttons
            document.getElementById('boatForward').addEventListener('click', () => {
                boatPositionZ -= boatSpeed * 0.05 * speedBoost;
                boatVelocity = -boatSpeed * speedBoost;
                riverDirection = -1;
            });
            
            document.getElementById('boatBackward').addEventListener('click', () => {
                boatPositionZ += boatSpeed * 0.05 * speedBoost;
                boatVelocity = boatSpeed * speedBoost;
                riverDirection = 1;
            });
            
            document.getElementById('boatLeft').addEventListener('click', () => {
                boatPositionX = Math.max(boatPositionX - 10, -riverWidth/2 + 5);
            });
            
            document.getElementById('boatRight').addEventListener('click', () => {
                boatPositionX = Math.min(boatPositionX + 10, riverWidth/2 + 5);
            });
            
            document.getElementById('boatCenter').addEventListener('click', () => {
                boatPositionX = 0;
                boatPositionZ = 0;
            });
            
            document.getElementById('boatBoost').addEventListener('click', () => {
                nitroActive = true;
                speedBoost = 2.5;
                setTimeout(() => {
                    nitroActive = false;
                    speedBoost = 1;
                }, 2000);
            });
            
            // Speed controls
            document.getElementById('speedUp').addEventListener('click', () => {
                boatSpeed = Math.min(boatSpeed + 25, 200);
                speedBoost = 1.5;
                setTimeout(() => speedBoost = 1, 1000);
            });
            
            // Weather controls
            document.getElementById('weatherSlider').addEventListener('input', (e) => {
                weatherIntensity = e.target.value / 100;
                document.getElementById('weatherIntensity').textContent = Math.floor(weatherIntensity * 5000);
                
                if(particleMaterial) {
                    particleMaterial.opacity = 0.3 + weatherIntensity * 0.7;
                    particleMaterial.size = 0.5 + weatherIntensity * 1.0;
                }
            });
            
            // Weather type buttons
            document.querySelectorAll('.weather-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.weather-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    weatherType = this.dataset.weather;
                    document.getElementById('weatherType').textContent = weatherType.toUpperCase();
                    
                    // Change particle color based on weather
                    if(particleMaterial) {
                        if(weatherType === 'snow') {
                            particleMaterial.color.set(0xffffff);
                        } else if(weatherType === 'rain') {
                            particleMaterial.color.set(0x00aaff);
                        } else if(weatherType === 'fog') {
                            particleMaterial.color.set(0xaaccff);
                        }
                    }
                });
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            const time = clock.getElapsedTime();
            
            // Update river material uniform
            if(riverMaterial && riverMaterial.uniforms) {
                riverMaterial.uniforms.time.value = time;
                riverMaterial.uniforms.speed.value = Math.abs(boatVelocity) * 0.01;
                riverMaterial.uniforms.snowAmount.value = weatherIntensity * 0.5;
            }
            
            // Move weather particles
            if(particleSystem && particleSystem.geometry) {
                const positions = particleSystem.geometry.attributes.position.array;
                
                for(let i = 0; i < positions.length; i += 3) {
                    // Different movement based on weather type
                    if(weatherType === 'snow') {
                        positions[i + 1] -= 1.5 * weatherIntensity;
                        positions[i] += Math.sin(time + positions[i + 2] * 0.01) * 0.1;
                    } else if(weatherType === 'rain') {
                        positions[i + 1] -= 4 * weatherIntensity;
                    } else if(weatherType === 'fog') {
                        positions[i + 1] -= 0.5 * weatherIntensity;
                        positions[i] += Math.sin(time * 0.5 + positions[i + 2] * 0.01) * 0.05;
                    }
                    
                    // Reset particle if it falls too low
                    if(positions[i + 1] < -50) {
                        positions[i] = (Math.random() - 0.5) * 200;
                        positions[i + 1] = Math.random() * 100 + 50;
                        positions[i + 2] = (Math.random() - 0.5) * 500;
                    }
                }
                
                particleSystem.geometry.attributes.position.needsUpdate = true;
            }
            
            // Update boat animation
            if(boat) {
                // Smooth boat movement
                boat.position.x += (boatPositionX - boat.position.x) * 0.1;
                boat.position.z += (boatPositionZ - boat.position.z) * 0.1;
                
                // Boat height animation with waves
                boat.position.y = boatHeight + Math.sin(time * 2 + boat.position.z * 0.01) * 0.5;
                
                // Boat rotation based on movement
                boat.rotation.z = (boatPositionX - boat.position.x) * 0.03;
                boat.rotation.x = Math.sin(time) * 0.05 + (boatVelocity / 200) * 0.2;
                
                // Boat rotation based on river direction
                boat.rotation.y = riverDirection * 0.05;
                
                // Update distance traveled
                distanceTraveled += Math.abs(boatVelocity) * delta * 0.001;
                document.getElementById('distance').textContent = distanceTraveled.toFixed(1);
                
                // Create wake effect when moving
                if(Math.abs(boatVelocity) > 10 && time % 0.3 < 0.1) {
                    createWakeParticle();
                }
                
                // Engine glow effect when nitro is active
                if(nitroActive) {
                    const engineLight = boat.children.find(child => child.type === 'PointLight' && child.color.getHex() === 0xff3300);
                    if(engineLight) {
                        engineLight.intensity = 5 + Math.sin(time * 20) * 2;
                    }
                }
            }
            
            // Animate buildings (subtle movement for holographic effect)
            buildings.forEach((building, index) => {
                if(building.children && building.children.length > 0) {
                    // Find windows and animate their emissive intensity
                    building.children.forEach(child => {
                        if(child.material && child.material.emissive) {
                            child.material.emissiveIntensity = 1.5 + Math.sin(time * 2 + index) * 0.5;
                        }
                    });
                }
            });
            
            // Update light particles
            lightParticles.forEach(particles => {
                const positions = particles.geometry.attributes.position.array;
                for(let i = 0; i < positions.length; i += 3) {
                    positions[i + 1] -= 0.2;
                    if(positions[i + 1] < -50) {
                        positions[i + 1] = 50;
                    }
                    // Gentle horizontal movement
                    positions[i] += Math.sin(time + i * 0.01) * 0.05;
                }
                particles.geometry.attributes.position.needsUpdate = true;
            });
            
            // Update camera to follow boat
            camera.position.x += (boat.position.x * 0.5 - camera.position.x) * 0.05;
            camera.position.z = boat.position.z + 60;
            camera.position.y = 30 + Math.sin(time) * 2;
            
            // Make camera look at boat
            camera.lookAt(boat.position.x, boat.position.y + 5, boat.position.z);
            
            controls.update();
            composer.render();
        }

        function createWakeParticle() {
            const wakeGeometry = new THREE.RingGeometry(1, 3, 16);
            const wakeMaterial = new THREE.MeshBasicMaterial({
                color: nitroActive ? 0xff3300 : (riverDirection === -1 ? 0x00ff9d : 0x00ffff),
                transparent: true,
                opacity: 0.4,
                side: THREE.DoubleSide
            });
            
            const wake = new THREE.Mesh(wakeGeometry, wakeMaterial);
            wake.position.set(boat.position.x, -4.9, boat.position.z);
            wake.rotation.x = -Math.PI / 2;
            scene.add(wake);
            
            // Animate and remove wake
            let scale = 1;
            let opacity = 0.4;
            
            function animateWake() {
                scale += 0.8;
                opacity -= 0.03;
                
                wake.scale.set(scale, scale, 1);
                wakeMaterial.opacity = opacity;
                
                if(opacity > 0) {
                    requestAnimationFrame(animateWake);
                } else {
                    scene.remove(wake);
                    wakeMaterial.dispose();
                    wakeGeometry.dispose();
                }
            }
            
            animateWake();
        }

        function createSnowflakes() {
            const snowflakesContainer = document.getElementById('snowflakes');
            const snowflakeCount = 150;
            
            for(let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                
                // Random size
                const size = Math.random() * 5 + 2;
                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                
                // Random position
                snowflake.style.left = `${Math.random() * 100}vw`;
                snowflake.style.top = `${Math.random() * 100}vh`;
                
                // Random opacity
                snowflake.style.opacity = Math.random() * 0.7 + 0.3;
                
                // Animation
                const duration = Math.random() * 10 + 10;
                const delay = Math.random() * 5;
                
                snowflake.style.animation = `fall ${duration}s linear ${delay}s infinite`;
                
                // Add CSS animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fall {
                        0% {
                            transform: translateY(-100px) translateX(0px) rotate(0deg);
                            opacity: ${snowflake.style.opacity};
                        }
                        100% {
                            transform: translateY(100vh) translateX(${Math.random() * 200 - 100}px) rotate(360deg);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
                
                snowflakesContainer.appendChild(snowflake);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // UI CONTROLS
        document.getElementById('shopToggle').addEventListener('click', () => {
            document.getElementById('shopWindow').classList.add('active');
        });

        document.getElementById('shopToggleBtn').addEventListener('click', () => {
            document.getElementById('shopWindow').classList.toggle('active');
        });

        document.getElementById('connectWallet').addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CONNECTING...';
            this.style.opacity = '0.8';
            
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-check"></i> CONNECTED';
                this.style.background = 'linear-gradient(45deg, #00ff9d, #00f0ff)';
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.style.opacity = '1';
                    this.style.background = 'linear-gradient(45deg, #00f0ff, #9d00ff)';
                }, 3000);
            }, 1500);
        });

        function buyProduct(product) {
            alert(`Purchasing ${product.toUpperCase()}...\n\nRedirecting to checkout.`);
        }
    </script>
</body>
</html>
